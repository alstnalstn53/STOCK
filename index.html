<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Market Studio – Yahoo Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f5;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-sub: #6b7280;
      --line: #e5e7eb;
      --accent: #111827;
      --positive: #16a34a;
      --negative: #dc2626;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 32px 24px 40px;
      background: var(--bg);
      color: var(--text-main);
    }
    .page {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 24px;
      margin-bottom: 32px;
      border-bottom: 1px solid var(--line);
      padding-bottom: 16px;
    }
    .title-block h1 {
      margin: 0 0 4px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 18px;
    }
    .title-block .sub {
      font-size: 12px;
      color: var(--text-sub);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }
    .meta {
      text-align: right;
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.5;
    }
    .controls {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
    }
    .controls button {
      border-radius: 999px;
      border: 1px solid var(--text-main);
      background: var(--text-main);
      color: white;
      font-size: 11px;
      padding: 5px 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
    }
    .controls button:hover {
      opacity: 0.9;
    }
    main {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
        align-items: stretch;
      }
      .meta {
        text-align: left;
      }
    }
    section.card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px 18px 14px;
      border: 1px solid var(--line);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 10px;
    }
    .card-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-weight: 500;
    }
    .card-sub {
      font-size: 11px;
      color: var(--text-sub);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .tag {
      font-size: 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      padding: 3px 8px;
      color: var(--text-sub);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      white-space: nowrap;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #f3f4f6;
      text-align: right;
      white-space: nowrap;
    }
    th:first-child,
    td:first-child {
      text-align: left;
    }
    th {
      font-weight: 500;
      color: var(--text-sub);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .muted { color: var(--text-sub); }
    .positive { color: var(--positive); }
    .negative { color: var(--negative); }
    .clickable-row { cursor: pointer; }
    .clickable-row:hover { background: #f9fafb; }
    .small-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
    }
    .news-layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 4px;
    }
    .news-column-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    .news-column-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-sub);
    }
    .news-symbol-label {
      font-size: 11px;
      color: var(--text-sub);
    }
    .news-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .news-item {
      padding: 6px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .news-item:last-child {
      border-bottom: none;
    }
    .news-title {
      font-size: 12px;
      margin-bottom: 2px;
    }
    .news-meta {
      font-size: 10px;
      color: var(--text-sub);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .news-title a {
      color: var(--text-main);
      text-decoration: none;
    }
    .news-title a:hover { text-decoration: underline; }

    .sector-block {
      margin-top: 10px;
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
    }
    .sector-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    #company-insight {
      font-size: 12px;
      line-height: 1.6;
      min-height: 80px;
    }
    #company-insight strong { font-weight: 600; }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title-block">
        <h1>Market Studio</h1>
        <div class="sub">Equities · Crypto · FX · Yield · News</div>
      </div>
      <div class="meta">
        <div id="last-updated">Last update – –</div>
        <div class="controls">
          <button id="manual-refresh">REFRESH</button>
        </div>
      </div>
    </header>

    <main>
      <!-- 왼쪽 -->
      <div class="left-column">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Equities</div>
              <div class="card-sub">AI · Data Center · Ecosystem</div>
            </div>
            <div class="tag">Yahoo Finance (unofficial)</div>
          </div>
          <div id="stocks-container"></div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Company Insight</div>
              <div class="card-sub">Sector · Role · Moat</div>
            </div>
            <div class="tag">Curated</div>
          </div>
          <div id="company-insight">
            <div class="small-note">
              왼쪽 Equities 섹션에서 종목을 클릭하면
              이 영역에 간단한 섹터/역할/AI·데이터센터 포지션을 보여줄 수 있게
              확장할 수 있습니다. 지금은 기본 안내만 표시합니다.
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Crypto</div>
              <div class="card-sub">Spot · USD & KRW</div>
            </div>
            <div class="tag">CoinGecko</div>
          </div>
          <table id="crypto-table">
            <thead>
              <tr>
                <th>Symbol</th>
                <th>Name</th>
                <th>USD</th>
                <th>KRW</th>
                <th>24h</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>
      </div>

      <!-- 오른쪽 -->
      <div class="right-column">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">FX</div>
              <div class="card-sub">USD / KRW</div>
            </div>
            <div class="tag">Frankfurter</div>
          </div>
          <table id="fx-table">
            <thead>
              <tr>
                <th>Pair</th>
                <th>Rate</th>
                <th>Base</th>
                <th>Quote</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Staking Yield</div>
              <div class="card-sub">Manual Snapshot · APY</div>
            </div>
            <div class="tag">On-chain / CeFi</div>
          </div>
          <table id="staking-table">
            <thead>
              <tr>
                <th>Asset</th>
                <th>Platform</th>
                <th>APY</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="small-note">
            지금은 수동 입력 값입니다. 나중에 DeFiLlama 같은 곳에서 자동화 가능.
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">News</div>
              <div class="card-sub">(옵션) Finnhub / 기타 API</div>
            </div>
            <div class="tag">Placeholder</div>
          </div>
          <div class="small-note">
            지금은 뉴스 API를 연결하지 않았습니다. Finnhub 키를 쓰고 싶으면
            여기에 바로 붙일 수 있게 구조는 미리 잡아둔 상태입니다.
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== 데이터 정의 =====
    const stocks = [
      { symbol: "AAPL",  name: "Apple" },
      { symbol: "ABNB",  name: "Airbnb" },
      { symbol: "ADBE",  name: "Adobe" },
      { symbol: "AG",    name: "First Majestic Silver" },
      { symbol: "AGX",   name: "Argan" },
      { symbol: "ALAB",  name: "Astera Labs" },
      { symbol: "ALL",   name: "Allstate" },
      { symbol: "AMAT",  name: "Applied Materials" },
      { symbol: "AMGN",  name: "Amgen" },
      { symbol: "AMZN",  name: "Amazon" },
      { symbol: "ANET",  name: "Arista Networks" },
      { symbol: "ANSS",  name: "Ansys" },
      { symbol: "APP",   name: "AppLovin" },
      { symbol: "ARM",   name: "Arm Holdings" },
      { symbol: "ASML",  name: "ASML" },
      { symbol: "AVGO",  name: "Broadcom" },

      { symbol: "BE",    name: "Bloom Energy" },
      { symbol: "BK",    name: "Bank of New York Mellon" },
      { symbol: "BLK",   name: "BlackRock" },
      { symbol: "BMNR",  name: "BitMine Immersion Technologies" },
      { symbol: "BSX",   name: "Boston Scientific" },
      { symbol: "BTDR",  name: "Bitdeer Technologies" },

      { symbol: "CAT",   name: "Caterpillar" },
      { symbol: "CDNS",  name: "Cadence Design Systems" },
      { symbol: "CDNA",  name: "CareDx" },
      { symbol: "CEG",   name: "Constellation Energy" },
      { symbol: "CELH",  name: "Celsius Holdings" },
      { symbol: "CL",    name: "Colgate-Palmolive" },
      { symbol: "CLSK",  name: "CleanSpark" },
      { symbol: "CLS",   name: "Celestica" },
      { symbol: "COHR",  name: "Coherent" },
      { symbol: "COIN",  name: "Coinbase" },
      { symbol: "COST",  name: "Costco" },
      { symbol: "CRDO",  name: "Credo Technology" },
      { symbol: "CRM",   name: "Salesforce" },
      { symbol: "CSCO",  name: "Cisco Systems" },
      { symbol: "C3AI",  name: "C3.ai" },
      { symbol: "CRS",   name: "Carpenter Technology" },

      { symbol: "DASH",  name: "DoorDash" },
      { symbol: "DDOG",  name: "Datadog" },
      { symbol: "DE",    name: "Deere & Company" },
      { symbol: "DLR",   name: "Digital Realty Trust" },
      { symbol: "DHI",   name: "D.R. Horton" },
      { symbol: "DIS",   name: "Walt Disney" },

      { symbol: "ETN",   name: "Eaton" },
      { symbol: "ETOR",  name: "eToro Group" },
      { symbol: "ETRN",  name: "Equitrans Midstream" },
      { symbol: "EW",    name: "Edwards Lifesciences" },
      { symbol: "EXAS",  name: "Exact Sciences" },
      { symbol: "EQIX",  name: "Equinix" },

      { symbol: "FABR",  name: "Fabrinet" },
      { symbol: "FSLR",  name: "First Solar" },
      { symbol: "FUTU",  name: "Futu Holdings" },

      { symbol: "GE",    name: "GE Aerospace" },
      { symbol: "GEL",   name: "Genesis Energy" },
      { symbol: "GEN",   name: "Generac" },
      { symbol: "GME",   name: "GameStop" },
      { symbol: "GOOGL", name: "Alphabet (Google)" },
      { symbol: "GCM",   name: "Genius Sports" },

      { symbol: "HPE",   name: "Hewlett Packard Enterprise" },
      { symbol: "HUT",   name: "Hut 8 Mining" },

      { symbol: "IBM",   name: "IBM" },
      { symbol: "IESC",  name: "IES Holdings" },
      { symbol: "INTC",  name: "Intel" },
      { symbol: "IONQ",  name: "IonQ" },
      { symbol: "ISRG",  name: "Intuitive Surgical" },
      { symbol: "ITRI",  name: "Itron" },
      { symbol: "IVZ",   name: "Invesco" },

      { symbol: "JBL",   name: "Jabil" },
      { symbol: "JNPR",  name: "Juniper Networks" },

      { symbol: "KO",    name: "Coca-Cola" },
      { symbol: "KTOS",  name: "Kratos Defense" },

      { symbol: "LLY",   name: "Eli Lilly" },
      { symbol: "LMT",   name: "Lockheed Martin" },
      { symbol: "LRCX",  name: "Lam Research" },
      { symbol: "LOW",   name: "Lowe’s" },

      { symbol: "MARA",  name: "Marathon Digital" },
      { symbol: "MCHP",  name: "Microchip Technology" },
      { symbol: "META",  name: "Meta Platforms" },
      { symbol: "MNTK",  name: "Montauk Renewables" },
      { symbol: "MRNA",  name: "Moderna" },
      { symbol: "MRVL",  name: "Marvell Technology" },
      { symbol: "MP",    name: "MP Materials" },
      { symbol: "MU",    name: "Micron Technology" },
      { symbol: "MSFT",  name: "Microsoft" },
      { symbol: "MPW",   name: "Medical Properties Trust" },

      { symbol: "NET",   name: "Cloudflare" },
      { symbol: "NEE",   name: "NextEra Energy" },
      { symbol: "NFLX",  name: "Netflix" },
      { symbol: "NIO",   name: "NIO" },
      { symbol: "NRIX",  name: "Nurix Therapeutics" },
      { symbol: "NOW",   name: "ServiceNow" },
      { symbol: "NU",    name: "Nu Holdings" },
      { symbol: "NVDA",  name: "NVIDIA" },
      { symbol: "NUE",   name: "Nucor" },

      { symbol: "OKLO",  name: "Oklo" },
      { symbol: "ORCL",  name: "Oracle" },
      { symbol: "OTTR",  name: "Otter Tail" },

      { symbol: "PAGS",  name: "PagSeguro" },
      { symbol: "PANW",  name: "Palo Alto Networks" },
      { symbol: "PATH",  name: "UiPath" },
      { symbol: "PEP",   name: "PepsiCo" },
      { symbol: "PH",    name: "Parker-Hannifin" },
      { symbol: "PLTR",  name: "Palantir" },
      { symbol: "PNW",   name: "Pinnacle West" },
      { symbol: "PYPL",  name: "PayPal" },

      { symbol: "QCOM",  name: "Qualcomm" },
      { symbol: "QSR",   name: "Restaurant Brands Intl." },

      { symbol: "RBLX",  name: "Roblox" },
      { symbol: "RDFN",  name: "Redfin" },
      { symbol: "RIOT",  name: "Riot Platforms" },

      { symbol: "SBUX",  name: "Starbucks" },
      { symbol: "SMCI",  name: "Super Micro Computer" },
      { symbol: "SMR",   name: "NuScale Power" },
      { symbol: "SITM",  name: "SiTime" },
      { symbol: "SHOP",  name: "Shopify" },
      { symbol: "SNOW",  name: "Snowflake" },
      { symbol: "SOFI",  name: "SoFi" },
      { symbol: "SPOT",  name: "Spotify" },
      { symbol: "SQ",    name: "Block" },
      { symbol: "STLD",  name: "Steel Dynamics" },
      { symbol: "STRL",  name: "Sterling Infrastructure" },
      { symbol: "STX",   name: "Seagate" },
      { symbol: "SWKS",  name: "Skyworks" },

      { symbol: "TDY",   name: "Teledyne" },
      { symbol: "TEAM",  name: "Atlassian" },
      { symbol: "TEVA",  name: "Teva" },
      { symbol: "TMO",   name: "Thermo Fisher" },
      { symbol: "TSLA",  name: "Tesla" },
      { symbol: "TSM",   name: "Taiwan Semi" },
      { symbol: "TTM",   name: "TTM Technologies" },
      { symbol: "TWLO",  name: "Twilio" },

      { symbol: "UBER",  name: "Uber" },
      { symbol: "UPST",  name: "Upstart" },

      { symbol: "VCYT",  name: "Veracyte" },
      { symbol: "VMC",   name: "Vulcan Materials" },
      { symbol: "VRTX",  name: "Vertex" },
      { symbol: "VRT",   name: "Vertiv" },
      { symbol: "VZ",    name: "Verizon" },

      { symbol: "WDC",   name: "Western Digital" },
      { symbol: "WMT",   name: "Walmart" },
      { symbol: "WTW",   name: "Willis Towers Watson" },

      { symbol: "ZI",    name: "ZoomInfo" },
      { symbol: "ZBRA",  name: "Zebra" },
      { symbol: "ZM",    name: "Zoom Video" }
    ];

    const sectorTag = {
      // AI / 데이터센터 코어
      NVDA: "AI / Data Center Core",
      MSFT: "AI / Data Center Core",
      AMZN: "AI / Data Center Core",
      META: "AI / Data Center Core",
      GOOGL:"AI / Data Center Core",
      SMCI: "AI / Data Center Core",
      ANET: "AI / Data Center Core",
      VRT:  "AI / Data Center Core",
      EQIX: "AI / Data Center Core",
      DLR:  "AI / Data Center Core",
      NOW:  "AI / Data Center Core",
      NET:  "AI / Data Center Core",
      SNOW: "AI / Data Center Core",
      DDOG: "AI / Data Center Core",
      PLTR: "AI / Data Center Core",
      CRM:  "AI / Data Center Core",

      // 반도체 / EDA
      AVGO: "Semiconductors & EDA",
      ASML: "Semiconductors & EDA",
      CDNS: "Semiconductors & EDA",
      MRVL: "Semiconductors & EDA",
      TSM:  "Semiconductors & EDA",
      SITM: "Semiconductors & EDA",
      INTC: "Semiconductors & EDA",
      MU:   "Semiconductors & EDA",
      AMAT: "Semiconductors & EDA",
      LRCX: "Semiconductors & EDA",
      MCHP: "Semiconductors & EDA",
      COHR: "Semiconductors & EDA",
      ARM:  "Semiconductors & EDA",
      SWKS: "Semiconductors & EDA",

      // 에너지 / 전력 / 원전
      BE:   "Energy / Power / Nuclear",
      CEG:  "Energy / Power / Nuclear",
      NEE:  "Energy / Power / Nuclear",
      SMR:  "Energy / Power / Nuclear",
      OKLO: "Energy / Power / Nuclear",
      MNTK: "Energy / Power / Nuclear",
      ETN:  "Energy / Power / Nuclear",
      PNW:  "Energy / Power / Nuclear",

      // 금융 / 브로커 / 자산운용
      BLK:  "Financials / Brokers",
      BK:   "Financials / Brokers",
      NU:   "Financials / Brokers",
      SOFI: "Financials / Brokers",
      COIN: "Financials / Brokers",
      FUTU: "Financials / Brokers",
      ETOR: "Financials / Brokers",
      IVZ:  "Financials / Brokers",
      PYPL: "Financials / Brokers",
      UPST: "Financials / Brokers",

      // 크립토 마이너
      MARA:"Crypto Miners",
      RIOT:"Crypto Miners",
      BTDR:"Crypto Miners",
      HUT: "Crypto Miners",
      BMNR:"Crypto Miners",
      CLSK:"Crypto Miners",

      // 헬스케어
      LLY:"Healthcare / Bio",
      AMGN:"Healthcare / Bio",
      MRNA:"Healthcare / Bio",
      ISRG:"Healthcare / Bio",
      EXAS:"Healthcare / Bio",
      VRTX:"Healthcare / Bio",
      TEVA:"Healthcare / Bio",
      EW:"Healthcare / Bio",
      CDNA:"Healthcare / Bio",
      VCYT:"Healthcare / Bio",
      NRIX:"Healthcare / Bio",
      TMO:"Healthcare / Bio",

      // 컨슈머 / 브랜드
      AAPL:"Consumer / Brand",
      ABNB:"Consumer / Brand",
      CELH:"Consumer / Brand",
      DIS:"Consumer / Brand",
      NFLX:"Consumer / Brand",
      PEP:"Consumer / Brand",
      SBUX:"Consumer / Brand",
      WMT:"Consumer / Brand",
      SPOT:"Consumer / Brand",
      KO:"Consumer / Brand",
      COST:"Consumer / Brand",
      RBLX:"Consumer / Brand",
      GME:"Consumer / Brand",

      // 인더스트리 / 방산 / 인프라
      CAT:"Industrial / Infra",
      DE:"Industrial / Infra",
      STLD:"Industrial / Infra",
      VMC:"Industrial / Infra",
      MP:"Industrial / Infra",
      OTTR:"Industrial / Infra",
      STRL:"Industrial / Infra",
      KTOS:"Industrial / Infra",
      LMT:"Industrial / Infra",
      GE:"Industrial / Infra",
      PH:"Industrial / Infra",
      TDY:"Industrial / Infra",
      IESC:"Industrial / Infra"
    };

    const cryptos = [
      { id: "bitcoin",      symbol: "BTC",  name: "Bitcoin" },
      { id: "ethereum",     symbol: "ETH",  name: "Ethereum" },
      { id: "avalanche-2",  symbol: "AVAX", name: "Avalanche" },
      { id: "sui",          symbol: "SUI",  name: "Sui" },
      { id: "aptos",        symbol: "APT",  name: "Aptos" }
    ];

    const stakingManual = [
      { asset: "AVAX", platform: "Bybit Earn",      apy: 7.5, note: "30d Lock" },
      { asset: "SUI",  platform: "On-chain Staking", apy: 6.2, note: "Validator" },
      { asset: "APT",  platform: "On-chain Staking", apy: 7.0, note: "Est." }
    ];

    let usdKrwRate = null;

    // ===== 유틸 =====
    function formatNumber(n, decimals = 2) {
      if (n === null || n === undefined || isNaN(n)) return "–";
      return Number(n).toLocaleString("en-US", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function setLastUpdated() {
      const el = document.getElementById("last-updated");
      const now = new Date();
      const pad = (x) => String(x).padStart(2, "0");
      el.textContent =
        `Last update ${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} `
        + `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    }

    // ===== Equities 렌더링 =====
    function renderStocksTableSkeleton() {
      const container = document.getElementById("stocks-container");
      if (!container) return;

      const groups = {};
      for (const s of stocks) {
        const sector = sectorTag[s.symbol] || "Other / Unclassified";
        if (!groups[sector]) groups[sector] = [];
        groups[sector].push(s);
      }
      const sectorNames = Object.keys(groups).sort();

      const html = sectorNames.map((sector) => {
        const rows = groups[sector]
          .sort((a, b) => a.symbol.localeCompare(b.symbol))
          .map((s) => `
            <tr class="clickable-row" data-symbol="${s.symbol}">
              <td>${s.symbol}</td>
              <td>${s.name}</td>
              <td id="price-${s.symbol}">–</td>
              <td id="chg-${s.symbol}" class="muted">–</td>
              <td id="chgPct-${s.symbol}" class="muted">–</td>
            </tr>
          `).join("");
        return `
          <div class="sector-block">
            <div class="sector-title">${sector}</div>
            <table>
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Name</th>
                  <th>Price (USD)</th>
                  <th>Change</th>
                  <th>Δ%</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          </div>
        `;
      }).join("");

      container.innerHTML = html;

      document.querySelectorAll("#stocks-container .clickable-row")
        .forEach((row) => {
          row.addEventListener("click", () => {
            const sym = row.getAttribute("data-symbol");
            showCompanyInsight(sym);
          });
        });
    }

    async function fetchYahooQuotes() {
      try {
        const symbolsParam = stocks.map(s => s.symbol).join(",");
        const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbolsParam)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Yahoo quote HTTP error");
        const data = await res.json();
        const results = data?.quoteResponse?.result || [];

        for (const q of results) {
          const sym = q.symbol;
          const price = q.regularMarketPrice;
          const change = q.regularMarketChange;
          const changePct = q.regularMarketChangePercent;

          const priceEl = document.getElementById(`price-${sym}`);
          const chgEl = document.getElementById(`chg-${sym}`);
          const chgPctEl = document.getElementById(`chgPct-${sym}`);
          if (!priceEl || !chgEl || !chgPctEl) continue;

          const cls =
            change > 0 ? "positive" : change < 0 ? "negative" : "muted";
          priceEl.textContent = formatNumber(price, 2);
          chgEl.textContent = formatNumber(change, 2);
          chgPctEl.textContent =
            changePct === null || changePct === undefined || isNaN(changePct)
              ? "–"
              : `${changePct > 0 ? "+" : ""}${changePct.toFixed(2)}%`;

          chgEl.className = cls;
          chgPctEl.className = cls;
        }
      } catch (e) {
        console.error("Yahoo quote error", e);
      }
    }

    // ===== Company Insight (간단 버전) =====
    function showCompanyInsight(symbol) {
      const box = document.getElementById("company-insight");
      const info = stocks.find(s => s.symbol === symbol);
      const sector = sectorTag[symbol] || "Other / Unclassified";
      if (!info || !box) return;

      box.innerHTML = `
        <p><strong>${symbol}</strong> · ${info.name}</p>
        <p class="muted" style="margin-top:4px;">Sector group: ${sector}</p>
        <p style="margin-top:8px;">
          이 종목에 대한 상세 프로필은 아직 텍스트로 작성하지 않았습니다.
          나중에 섹터, 역할, AI·데이터센터 노출 정도, 마진/성장 특성 등을
          여기에 서술형으로 채워 넣을 수 있습니다.
        </p>
      `;
    }

    // ===== FX (USD/KRW) =====
    async function fetchFX() {
      const tbody = document.querySelector("#fx-table tbody");
      if (!tbody) return;
      tbody.innerHTML = `
        <tr><td>USD/KRW</td><td colspan="3" class="muted">Loading…</td></tr>
      `;
      try {
        const res = await fetch("https://api.frankfurter.app/latest?from=USD&to=KRW");
        if (!res.ok) throw new Error("FX HTTP error");
        const data = await res.json();
        const rate = data?.rates?.KRW;
        usdKrwRate = rate || null;

        tbody.innerHTML = `
          <tr>
            <td>USD/KRW</td>
            <td>${formatNumber(rate, 2)}</td>
            <td>USD</td>
            <td>KRW</td>
          </tr>
        `;
      } catch (e) {
        console.error("FX error", e);
        tbody.innerHTML = `
          <tr>
            <td>USD/KRW</td>
            <td colspan="3" class="muted">Error</td>
          </tr>
        `;
      }
    }

    // ===== Crypto =====
    async function fetchCryptos() {
      const tbody = document.querySelector("#crypto-table tbody");
      if (!tbody) return;
      tbody.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;

      try {
        const ids = cryptos.map(c => c.id).join(",");
        const url =
          `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}`
          + "&vs_currencies=usd,krw&include_24hr_change=true";
        const res = await fetch(url);
        if (!res.ok) throw new Error("CG HTTP error");
        const data = await res.json();

        const rows = cryptos.map((c) => {
          const d = data[c.id] || {};
          const usd = d.usd;
          const krw = d.krw !== undefined ? d.krw :
                      (usdKrwRate && usd ? usd * usdKrwRate : null);
          const chg = d.usd_24h_change;
          const cls =
            chg > 0 ? "positive" : chg < 0 ? "negative" : "muted";
          const pctText =
            chg === null || chg === undefined || isNaN(chg)
              ? "–"
              : `${chg > 0 ? "+" : ""}${chg.toFixed(2)}%`;

          return `
            <tr>
              <td>${c.symbol}</td>
              <td>${c.name}</td>
              <td>${formatNumber(usd, 2)}</td>
              <td>${formatNumber(krw, 0)}</td>
              <td class="${cls}">${pctText}</td>
            </tr>
          `;
        }).join("");

        tbody.innerHTML = rows;
      } catch (e) {
        console.error("crypto error", e);
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Error</td></tr>`;
      }
    }

    // ===== Staking (수동) =====
    function renderStakingManual() {
      const tbody = document.querySelector("#staking-table tbody");
      if (!tbody) return;
      const rows = stakingManual.map((s) => `
        <tr>
          <td>${s.asset}</td>
          <td>${s.platform}</td>
          <td>${s.apy.toFixed(2)}%</td>
          <td>${s.note}</td>
        </tr>
      `).join("");
      tbody.innerHTML = rows;
    }

    // ===== 전체 새로고침 =====
    async function refreshAll() {
      setLastUpdated();
      renderStakingManual();
      await fetchFX();
      await fetchCryptos();
      await fetchYahooQuotes();
    }

    document.getElementById("manual-refresh").addEventListener("click", () => {
      refreshAll();
    });

    // 초기화
    renderStocksTableSkeleton();
    refreshAll();
  </script>
</body>
</html>
